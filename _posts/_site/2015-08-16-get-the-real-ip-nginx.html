<h3 id="nginxip">多层nginx中获取真实ip</h3>

<p>在多层nginx中，若在后层的代理服务器中获得真实的用户IP，而不是上一层的代理服务器的IP，在反向代理服务器在转发请求的http头信息中，可以增加x_forwarded_for信息，用以记录原有客户端的IP地址和原来客户端的请求的服务器地址；即如下添加：</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">server</span> <span class="p">{</span>

  <span class="n">proxy_set_header</span>            <span class="no">Host</span> <span class="vg">$host</span><span class="p">;</span>

  <span class="n">proxy_set_header</span>            <span class="no">X</span><span class="o">-</span><span class="no">Real</span><span class="o">-</span><span class="no">Ip</span> <span class="vg">$remote_addr</span><span class="p">;</span>

  <span class="n">proxy_set_header</span>            <span class="no">X</span><span class="o">-</span><span class="no">Forwarded</span><span class="o">-</span><span class="no">For</span> <span class="vg">$proxy_add_x_forwarded_for</span><span class="p">;</span>

<span class="p">}</span></code></pre></figure>

<p>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for 一句会一层一层的记录转发信息
$http_x_forwarded_for记录的是原始用户的IP</p>

